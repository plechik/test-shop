{% extends 'base.html' %}
{% load static %}

{% block title %}Редактирование {{ product.name }} - Магазин "Evrika"{% endblock %}
{% block css %}<link rel="stylesheet" href="{% static 'css/detail_update.css' %}">{% endblock %}

{% block content %}
<div class="admin-page-container">

    <div class="form-grid">
        <main class="form-main-card">
            <header class="card-header-yellow">
                <h2><i class="bi bi-pencil-square"></i> Редактирование товара</h2>
                <span class="id-badge">ID: {{ product.id }}</span>
            </header>

            <form method="post" enctype="multipart/form-data" id="update-form" class="custom-form">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert-box error">
                    {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
                </div>
                {% endif %}

                <div class="form-group">
                    <label class="fw-bold">Название товара <span>*</span></label>
                    {{ form.name }}
                    {% if form.name.errors %}<div class="field-error">{{ form.name.errors.0 }}</div>{% endif %}
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="fw-bold">Категория <span>*</span></label>
                        {{ form.category }}
                    </div>
                    <div class="form-group">
                        <label class="fw-bold">Цена (руб.) <span>*</span></label>
                        <div class="input-with-unit">
                            {{ form.price }}
                            <span class="unit">₽</span>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="fw-bold">Описание</label>
                    {{ form.description }}
                </div>

                <div class="form-group">
                    <label class="fw-bold">Изменить изображение</label>
                    {{ form.image }}
                    <div id="new-image-preview" class="preview-box" style="display: none;">
                        <img id="image-preview" src="#" alt="Предпросмотр">
                    </div>
                </div>

                <div class="form-actions">
                    <a href="{{ product.get_absolute_url }}" class="btn-cancel-text">Отмена</a>
                    <div class="btn-group-save">
                        <button type="submit" class="btn-save-main">Сохранить</button>
                        <button type="submit" name="save_and_continue" value="1" class="btn-save-alt">И продолжить</button>
                    </div>
                </div>
            </form>
        </main>

        <aside class="form-sidebar">
            <div class="info-card">
                <h3>Текущее фото</h3>
                <img src="{{ product.get_image_url }}" alt="Current" class="current-img">
                {% if product.image %}
                <form method="post" action="{% url 'shop:delete_product_image' product.pk %}">
                    {% csrf_token %}
                    <button type="submit" class="btn-link-danger">Удалить файл</button>
                </form>
                {% endif %}
            </div>

            <div class="info-card meta-info">
                <h3>Статистика</h3>
                <p><b>Создан:</b> {{ product.created_at|date:"d.m.Y" }}</p>
                <p><b>Изменен:</b> {{ product.updated_at|date:"d.m.Y" }}</p>
                <hr>
                <div class="sidebar-buttons">
                    <a href="{{ product.get_absolute_url }}" class="btn-side"><i class="bi bi-eye"></i> Просмотр</a>
                    <a href="{% url 'shop:product_delete' product.pk %}" class="btn-side danger"><i class="bi bi-trash"></i> Удалить</a>
                </div>
            </div>
        </aside>
    </div>
</div>

<script>
    // Предпросмотр изображения
    document.getElementById('id_image').addEventListener('change', function(e) {
        const preview = document.getElementById('image-preview');
        const container = document.getElementById('new-image-preview');
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => { preview.src = e.target.result; container.style.display = 'block'; }
            reader.readAsDataURL(this.files[0]);
        }
    });

    // Предупреждение о выходе
    let changed = false;
    document.querySelectorAll('input, textarea, select').forEach(el => {
        el.addEventListener('change', () => changed = true);
    });
    window.addEventListener('beforeunload', (e) => {
        if (changed) e.returnValue = 'Есть несохраненные изменения!';
    });
    document.getElementById('update-form').addEventListener('submit', () => changed = false);
</script>
{% endblock %}